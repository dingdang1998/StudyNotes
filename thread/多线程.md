# å¤šçº¿ç¨‹

## å¤šçº¿ç¨‹åŸºç¡€æ¦‚å¿µ

å¤šçº¿ç¨‹æŠ€æœ¯æ˜¯ä»è½¯ä»¶æˆ–ç¡¬ä»¶ä¸Šå¤šä¸ªçº¿ç¨‹å¹¶å‘æ‰§è¡Œçš„æŠ€æœ¯

### è¿›ç¨‹å’Œçº¿ç¨‹çš„å…³ç³»

- è¿›ç¨‹ï¼šåº”ç”¨ç¨‹åºï¼ˆQQã€å¾®ä¿¡ï¼‰çš„æ‰§è¡Œå®ä¾‹ï¼›æœ‰ç‹¬ç«‹çš„å†…å­˜ç©ºé—´ å’Œç³»ç»Ÿèµ„æº

- çº¿ç¨‹ï¼šå°†è¿›ç¨‹å¯ä»¥è¿›ä¸€æ­¥ç»†åˆ† ä¸ºçº¿ç¨‹ï¼›CPUè°ƒåº¦å’Œåˆ†æ´¾çš„æœ€å°å•ä½

  ä¸¾ä¾‹ï¼ŒQQæ˜¯ä¸€ä¸ªè¿›ç¨‹ï¼ŒQQåˆå¯ä»¥ç»†åˆ†å¤šä¸ªåŠŸèƒ½ï¼ˆæ¥æ”¶æ¶ˆæ¯ã€å‘é€æ¶ˆæ¯ï¼‰ï¼Œæ¯ä¸ªåŠŸèƒ½éƒ½å¯ä»¥é€šè¿‡ä¸€ä¸ªçº¿ç¨‹æ¥å®ç°

> å¤šçº¿ç¨‹ï¼šå‰æï¼Œç ”ç©¶çš„å•æ ¸CPU

**å¤šçº¿ç¨‹ï¼šå®è§‚å¹¶è¡Œï¼Œå¾®è§‚ä¸²è¡Œ**

å•æ ¸CPUä¸­ï¼Œä¸å­˜åœ¨çœŸæ­£çš„â€å¹¶è¡Œâ€œæ¦‚å¿µï¼Œ å¤šä¸ªçº¿ç¨‹å®é™…æ˜¯åœ¨äº¤æ›¿çš„å ç”¨CPUï¼Œè€Œå¹¶ä¸æ˜¯çœŸæ­£â€å¹¶è¡Œæ‰§è¡Œâ€œ

### å¤šçº¿ç¨‹çš„ä¼˜ç‚¹

* å¤šçº¿ç¨‹å¯ä»¥å……åˆ†çš„åˆ©ç”¨CPUèµ„æºï¼Œæé«˜æ•ˆç‡

> è¡¥å……ï¼šå¤šçº¿ç¨‹å¹¶ä¸æ˜¯ è¶Šå¤šè¶Šå¥½ï¼ŒåŸå› ï¼š æ¯å¼€å¯ä¸€ä¸ªçº¿ç¨‹ ä¼šå ç”¨1Må·¦å³çš„å†…å­˜ï¼Œå› æ­¤å¤ªå¤šçš„çº¿ç¨‹ä¼šå ç”¨ å¤§é‡çš„å†…å­˜èµ„æºã€‚ å•çº¿ç¨‹æœ‰æ—¶å€™ æ€§èƒ½ä¹Ÿéå¸¸ä¸é”™ï¼Œä¾‹å¦‚NodeJsã€Nettyã€NIOéƒ½æ˜¯åŸºäºå•çº¿ç¨‹çš„ å¤šè·¯å¤ç”¨æŠ€æœ¯ï¼Œæ€§èƒ½ä¸æ¯”å¤šçº¿ç¨‹å·®ï¼Œå¤šçº¿ç¨‹å¹¶ä¸æ˜¯ç»å¯¹çš„å¯ä»¥æé«˜æ•ˆç‡ã€‚

* æˆ‘ä»¬ä¸€ç›´åœ¨ä½¿ç”¨çš„mainï¼ˆï¼‰å°±æ˜¯ä¸€ä¸ªçº¿ç¨‹ï¼Œå¹¶ä¸”æ˜¯ä¸»çº¿ç¨‹

```java
public class Test {
    public static void main(String[] args) {
        //è·å–å½“å‰çº¿ç¨‹
       Thread thread =  Thread.currentThread() ;
       //è·å–çº¿ç¨‹åå­—
        System.out.println(thread.getName());
        //è®¾ç½®çº¿ç¨‹åå­—
        thread.setName("hello");
        System.out.println(thread.getName());
    }
}
```

### åˆ›å»ºçº¿ç¨‹çš„æ–¹å¼

åœ¨javaä¸­å¯ä»¥é€šè¿‡ä»¥ä¸‹ä¸¤ç§  åŸºç¡€æ–¹å¼ åˆ›å»ºçº¿ç¨‹ï¼š

- ç»§æ‰¿java.lang.Threadç±»

- å®ç°java.lang.Runnableæ¥å£

å¤šä¸ªçº¿ç¨‹ä¹‹é—´ æ˜¯åœ¨â€œäº‰å¤ºâ€èµ„æºã€‚ä¸¾ä¸ªä¾‹å­ï¼Œå¦‚æœAå’ŒBè¿ä¸ªçº¿ç¨‹å»äº‰å¤ºcpuä½¿ç”¨æƒï¼Œå¦‚æœäº‰å¤ºäº†200æ¬¡ã€‚é‚£ä¹ˆè¿™200æ¬¡ä¸­çš„æŸä¸€æ¬¡ æ˜¯è¢«Aè¿˜æ˜¯Bå ç”¨ï¼Œå¯ä»¥ç†è§£ä¸ºæ˜¯éšæœºçš„

çº¿ç¨‹åœ¨æ‰§è¡Œæ—¶ä¸¤ä¸ªæœ€é‡è¦çš„æ–¹æ³•ï¼š

- å°†çº¿ç¨‹çš„æ‰§è¡Œé€»è¾‘ï¼ˆçº¿ç¨‹è¦åšçš„äº‹æƒ…ï¼‰å†™åœ¨run()ä¸­
- å¯åŠ¨çº¿ç¨‹ï¼Œæ˜¯é€šè¿‡start()å¯åŠ¨ã€‚  start() = å‡†å¤‡èµ„æº + è°ƒç”¨run()ã€‚çº¿ç¨‹çš„å¯åŠ¨ä¸èƒ½ä½¿ç”¨run.

é€šè¿‡threadå®ç°å¤šçº¿ç¨‹

```java
public class ThreadDemo01  extends Thread{
    //çº¿ç¨‹çš„æ‰§è¡Œæ–¹æ³•
    @Override
    public void run() {
        for(int i=0;i<100;i++){
            System.out.println(   Thread.currentThread().getName()+":"+i  );
        }
    }

    public static void main(String[] args) {
        ThreadDemo01 t1 = new ThreadDemo01();
        t1.setName("t1");
        ThreadDemo01 t2 = new ThreadDemo01();
        t2.setName("t2");

        t1.start();
        System.out.println("--------");
        t2.start();
    }
}

```

é€šè¿‡Runnableå®ç°å¤šçº¿ç¨‹

```java
public class ThreadDemo02 implements Runnable {

    //çº¿ç¨‹æ‰§è¡Œçš„æ–¹æ³•
    @Override
    public void run() {
        for(int i=0;i<100;i++){
            System.out.println(   Thread.currentThread().getName()+":"+i  );
        }
    }

    //Runnableæ–¹å¼ä»ç„¶æ˜¯å€Ÿç”¨Threadæ¥å®ç°çš„å¤šçº¿ç¨‹
    public static void main(String[] args) {
        ThreadDemo02 t1 = new ThreadDemo02();
        ThreadDemo02 t2 = new ThreadDemo02();


        //å¯åŠ¨çº¿ç¨‹éœ€è¦ä½¿ç”¨start()æ–¹æ³•ï¼Œä½†æ˜¯Runnableæ²¡æœ‰æä¾›startï¼ˆï¼‰,å¦‚ä½•è§£å†³ï¼Ÿ
        //Threadæœ‰start()   Runnableæ²¡æœ‰start()
        //Runnable ->Thread
        //Thread(Runable )
        Thread th1 = new Thread(  t1);
        Thread th2 = new Thread(  t2);
        th1.setName("T1");
        th2.setName("T2");
        th1.start();

        th2.start();


    }
}

```

**æ¨èä½¿ç”¨Runnableå®ç°å¤šçº¿ç¨‹ã€‚å› ä¸ºç°åœ¨çš„ä¸»æµæ˜¯<é¢å‘æ¥å£>å¼€å‘ï¼Œå³å»ºè®®å°½é‡ä½¿ç”¨æ¥å£ è€Œä¸è¦ä½¿ç”¨ç»§æ‰¿**

## çº¿ç¨‹çš„å¸¸è§API

* Thread t = new Thread(Runnableå¯¹è±¡);

* Thread t = new Thread(Runnableå¯¹è±¡ï¼Œçº¿ç¨‹åå­—);

* è®¾ç½®çº¿ç¨‹çš„ä¼˜å…ˆçº§setPriority(ä¼˜å…ˆçº§èŒƒå›´1- 10)ï¼Œä¼˜å…ˆçº§åªæ˜¯ä¸€ä¸ªå»ºè®®ï¼Œä½†ä¸èƒ½100%ä¿è¯ï¼ˆåªèƒ½æœ€å¤§åŒ–çš„å»ºè®®ï¼Œä¸èƒ½ä¿è¯100%ï¼‰

#### çº¿ç¨‹çš„ä¼‘çœ 

```java
            try {
                Thread.sleep(3000);//å•ä½æ˜¯ æ¯«ç§’
            } catch (InterruptedException e) {
                e.printStackTrace();
            }
```

æ˜¯å¦æ‰€æœ‰çš„çº¿ç¨‹éƒ½æ˜¯é€šè¿‡start()å¯åŠ¨ï¼Ÿä¸æ˜¯ï¼Œmain()

#### å¼ºåˆ¶æ‰§è¡Œã€çº¿ç¨‹çš„ç¤¼è®©

##### å¼ºåˆ¶æ‰§è¡Œ  

* join():å¼ºåˆ¶æ‰§è¡Œè°ƒç”¨join()çš„çº¿ç¨‹ï¼Œé˜»å¡å½“å‰æ­£åœ¨æ‰§è¡Œçš„çº¿ç¨‹ï¼ˆåˆ«çš„çº¿ç¨‹æ­£åœ¨æ‰§è¡Œï¼Œä½¿å…¶é˜»å¡ï¼ŒæŠ¢è¿‡èµ„æºè‡ªå·±æ‰§è¡Œï¼‰

```java
public class ThreadDemo03 implements Runnable {

    //Th1çº¿ç¨‹æ‰§è¡Œçš„æ–¹æ³•
    @Override
    public void run() {
        for(int i=0;i<10;i++){
            System.out.println(   Thread.currentThread().getName()+":"+i  );
        }
    }

    //çº¿ç¨‹th1:æ‰§è¡Œâ€œ T1:æ•°å­—â€
    //çº¿ç¨‹mainï¼šæ‰§è¡Œâ€œ main:æ•°å­—â€
    public static void main(String[] args) throws InterruptedException {
        ThreadDemo03 t1 = new ThreadDemo03();
        Thread th1 = new Thread(t1,"T1") ;
        //ä»è¿™ä¸€è¡Œå¼€å§‹ï¼Œmainå’Œth1äº’ç›¸äº‰å¤ºèµ„æºï¼Œå¯ä»¥æŠŠå¾ªç¯æ•°å­—æ”¾å¤§ï¼Œçœ‹åˆ°äº‰å¤ºå…³ç³»
        th1.start();
        //mainçº¿ç¨‹
        for(int i=0;i<10;i++){
            System.out.println(   Thread.currentThread().getName()+":"+i  );
            if(i==3){
                th1.join(); //mainçº¿ç¨‹æ­£åœ¨æ‰§è¡Œæ—¶ï¼ˆæ‰§è¡Œåˆ°i=3æ—¶ï¼‰ï¼Œ th1å¼ºåˆ¶æŠ¢å¤ºæ‰§è¡Œ
            }
        }
    }
}

```

![1574068114471](å¤šçº¿ç¨‹.assets/1574068114471.png)



##### çº¿ç¨‹çš„ç¤¼è®© 

* yield()ï¼Œç¤¼è®©ä»…ä»…æ˜¯ä¸€ç§ å°½å¯èƒ½äº‹ä»¶ï¼Œå¹¶ä¸ä¸€å®šä¼š100%æ‰§è¡Œ

```java
public class ThreadDemo03 implements Runnable {
    @Override
    public void run() {
        for(int i=0;i<10;i++){
            System.out.println(   Thread.currentThread().getName()+":"+i  );
            if(i == 3){
                Thread.yield();
                System.out.println("ç¤¼è®©....");
            }
        }
    }
    
    public static void main(String[] args) throws InterruptedException {
        ThreadDemo03 t1 = new ThreadDemo03();
        Thread th1 = new Thread(t1,"T1") ;
        th1.start();

        ThreadDemo03 t2 = new ThreadDemo03();
        Thread th2 = new Thread(t2,"T2") ;
        th2.start();
    }
}
```

## çº¿ç¨‹çŠ¶æ€

### çº¿ç¨‹æ‰§è¡Œéœ€è¦çš„èµ„æº

* CPUèµ„æº
* å…¶ä»–èµ„æºï¼ˆç¨‹åºè®¡æ•°å™¨ã€io.....ï¼‰

>ä¸€èˆ¬è€Œè¨€ï¼Œå…¶ä»–èµ„æºå®¹æ˜“è·å–ï¼Œè€ŒCPUæœ€éš¾è·å–

### çº¿ç¨‹è¿è¡Œçš„äº”ä¸ªçŠ¶æ€

* åˆ›å»º
* å°±ç»ªï¼šåªç¼ºCPUï¼Œä¸ç¼ºå…¶ä»–èµ„æº
* è¿è¡Œï¼šæœ‰CPU+æœ‰å…¶ä»–å…¨éƒ¨èµ„æº
* é˜»å¡ï¼šç¼ºCPU+ç¼ºå…¶ä»–èµ„æº

> Aã€Bä¸¤ä¸ªçº¿ç¨‹ï¼ŒAçº¿ç¨‹åœ¨æ‰“å°ï¼Œç»“æœæ‰“å°æœºè¢«æŠ¢å ï¼ˆå…¶ä»–èµ„æºï¼Œå…¶ä»–èµ„æºè¢«æŠ¢å ï¼ŒCPUä¹Ÿä¼šè¿åŒä¸€èµ·ç¼ºå¤±ï¼‰ï¼ŒAå°±ä¼šè¢«é˜»å¡

* æ­»äº¡

![ä¼ä¸šå¾®ä¿¡æˆªå›¾_16190590654958](å¤šçº¿ç¨‹.assets/ä¼ä¸šå¾®ä¿¡æˆªå›¾_16190590654958.png)

## å¤šçº¿ç¨‹ç¤ºä¾‹

1.é©¾æ ¡ç»ƒè½¦ï¼š æŸä¸ªé©¾æ ¡æ¯å¤©åªèƒ½ç»™30ä¸ªå­¦ç”Ÿç»ƒè½¦ï¼Œæœ‰20ä¸ªæ™®é€šå­¦ç”Ÿï¼Œ10ä¸ªvipã€‚å¼€å§‹æ—¶ï¼Œæ™®é€šå’ŒVIPå¹¶å‘å«å·

- å«åˆ°vipçš„æ¦‚ç‡æ¯”æ™®é€šçš„é«˜
- vipçš„ç»ƒè½¦æ—¶é—´æ˜¯æ™®é€šå­¦ç”Ÿçš„3å€
- è¦æ±‚vipå­¦ç”Ÿå¿…é¡»åœ¨ æ™®é€šå­¦å‘˜ä¹‹å‰å…¨éƒ¨ç»“æŸ

```java
package Thread;

class VipStudent implements Runnable {
    @Override
    public void run() {
        for (int i = 0; i < 10; i++) {
            System.out.println(i + "vipç»ƒè½¦......");
            try {
                Thread.sleep(3000);
            } catch (InterruptedException e) {
                e.printStackTrace();
            }
        }
    }
}

class NormalStudent implements Runnable {

    private Thread vip;

    public NormalStudent() {
    }

    public NormalStudent(Thread vip) {
        this.vip = vip;
    }

    @Override
    public void run() {
        for (int i = 0; i < 20; i++) {
            System.out.println(i + "æ™®é€šå­¦å‘˜ç»ƒè½¦......");
            //å¦‚æœæ™®é€šå­¦å‘˜åˆ°19ï¼Œå¼ºè¡Œæ’å…¥vip
            if (i == 18) {
                try {
                    vip.join();
                } catch (InterruptedException e) {
                    e.printStackTrace();
                }
            }

            try {
                Thread.sleep(1000);
            } catch (InterruptedException e) {
                e.printStackTrace();
            }
        }
    }
}

/**
 * @program: fileTest
 * @description: é©¾æ ¡ç»ƒè½¦
 * @author: dzp
 * @create: 2021-04-22 10:56
 **/
public class ThreadPracticeCar {
    public static void main(String[] args) {
        VipStudent vipStudent = new VipStudent();
        Thread vip = new Thread(vipStudent);
        NormalStudent normalStudent = new NormalStudent(vip);
        Thread normal = new Thread(normalStudent);
        //è®¾ç½®ä¼˜å…ˆçº§
        vip.setPriority(Thread.MAX_PRIORITY);
        normal.setPriority(Thread.NORM_PRIORITY);

        vip.start();
        normal.start();
    }
}
```

## æ•°æ®å®‰å…¨é—®é¢˜

å½“å¤šä¸ªçº¿ç¨‹å¹¶å‘è®¿é—®åŒä¸€ä¸ªèµ„æºæ—¶ï¼ˆå¯¹è±¡ã€æ–¹æ³•ã€ä»£ç å—ï¼‰ï¼Œç»å¸¸ä¼šå‡ºç°ä¸€äº›â€œä¸å®‰å…¨â€çš„çº¿ç¨‹ã€‚

ä¸¾ä¾‹ï¼šå‡è®¾æœ‰100å¼ ç«è½¦ç¥¨ï¼ŒåŒæ—¶è¢«aã€bä¸¤ä¸ªç«™ç‚¹å”®å–ã€‚

> çº¿ç¨‹å®‰å…¨é—®é¢˜  çº¿ç¨‹ä¸å®‰å…¨é—®é¢˜  å…¶å®æ˜¯ä¸€ä¸ªé—®é¢˜   

#### çº¿ç¨‹ä¸å®‰å…¨ä»£ç ç¤ºä¾‹

```java
package Thread;
/**
 * @program: fileTest
 * @description: å–è½¦ç¥¨é—®é¢˜
 * @author: dzp
 * @create: 2021-04-22 15:40
 **/
public class TicketsDemo implements Runnable {
    private int tickets = 10000;

    @Override
    public void run() {
        while (true) {
            //å–ç«è½¦ç¥¨
            sell();
        }
    }

    public void sell() {
        if (tickets > 0) {
            tickets--;
            System.out.println(Thread.currentThread().getName() + "-æ­£åœ¨å”®å–,å‰©ä½™ç¥¨æ•°ï¼š" + tickets);
        }
    }

    public static void main(String[] args) {
        TicketsDemo ticket = new TicketsDemo();

        Thread a = new Thread(ticket, "a");
        Thread b = new Thread(ticket, "b");

        a.start();
        b.start();
    }
}
```

* ä¸å®‰å…¨æƒ…å†µä¸€

![1574306060937](å¤šçº¿ç¨‹.assets/1574306060937.png)

* ä¸å®‰å…¨æƒ…å†µäºŒ

åªå‰©ä¸€å¼ ç¥¨ï¼Œaã€bæ‰§è¡Œåˆ°æ¨ªçº¿å¤„ï¼Œå¯èƒ½ä¼šæ‰“å°ç»“æœ**-1**

![ä¼ä¸šå¾®ä¿¡æˆªå›¾_16190758501799](C:\Users\admin\Desktop\JavaCore-master\JavaCore-master\notes\thread\å¤šçº¿ç¨‹.assets\ä¼ä¸šå¾®ä¿¡æˆªå›¾_16190758501799.png)

#### å¦‚ä½•è§£å†³ çº¿ç¨‹å®‰å…¨é—®é¢˜ï¼Ÿ 

* åŠ é”ï¼šå¯ä»¥ä¿è¯å¤šä¸ªçº¿ç¨‹ä¸²è¡Œæ‰§è¡Œï¼Œå³ä¸è¦ç›¸äº’äº‰å¤ºç€æŠ¢å èµ„æº

å«ç”Ÿé—´ï¼šaå’Œbå»å«ç”Ÿé—´ã€‚  å¦‚æœaæ­£åœ¨ä½¿ç”¨ï¼Œåˆ™åŠ ä¸€æŠŠé”ï¼Œè¡¨ç¤ºæ­£åœ¨ä½¿ç”¨....

##### synchronizedï¼šç»™å…±äº«çš„èµ„æºåŠ é”

###### åŠ é”çš„å½¢å¼

- ç»™æ–¹æ³•åŠ é”

public  synchornized è¿”å›å€¼ æ–¹æ³•å(){   ...  }

```java
    public  synchronized  void sell(){
        if(tickets > 0){
            tickets -- ;
            System.out.println(Thread.currentThread().getName()+"-æ­£åœ¨å”®å–,å‰©ä½™ç¥¨æ•°ï¼š" + tickets );
        }
    }
```

- ç»™ä»£ç å—åŠ é”

```java
    public  void sell(){
        synchronized (this) {//thisï¼šæ¢æˆå…¶ä»–ä»»æ„å¯¹è±¡éƒ½å¯ä»¥ï¼ˆä¾‹å¦‚ä¸Šå«ç”Ÿé—´æ—¶åŠ çš„é”å¯ä»¥æ˜¯ä¸€æŠŠçœŸå®çš„é”ï¼Œä¹Ÿå¯ä»¥æ˜¯ä¸€ä¸ªæç¤ºç‰Œ...ï¼‰
            if (tickets > 0) {
                tickets--;
                System.out.println(Thread.currentThread().getName() + "-æ­£åœ¨å”®å–,å‰©ä½™ç¥¨æ•°ï¼š" + tickets);
            }
        }
    }
```

##### è§£é”

è§£é”çš„æ—¶æœºæ˜¯ä»¥ä¸‹ä»»ä¸€ä¸ªæ¡ä»¶ï¼š

- æ­£å¸¸è§£é”ï¼šå°†sychronizedä¿®é¥°çš„æ–¹æ³•ã€ä»£ç å—æ‰§è¡Œå®Œæ¯•ï¼›
- å¼‚å¸¸è§£é”ï¼šå¦‚æœsychronizedä¿®é¥°çš„æ–¹æ³•å‡ºç°äº†å¼‚å¸¸ï¼Œåˆ™ä¼šè‡ªåŠ¨è§£é”

## æ­»é”

### æ­»é”çš„åŸå› 

resource-a å’Œresource-bä¸¤ä¸ªèµ„æºï¼Œä»¥åŠA\Bä¸¤ä¸ªçº¿ç¨‹ã€‚

Aï¼šå·²ç»å æœ‰ resource-aï¼Œç­‰å¾…ä½¿ç”¨resource-b

B:å·²ç»å æœ‰ resource-bï¼Œç­‰å¾…ä½¿ç”¨resource-a

### æ­»é”æ‰€é€ æˆçš„å½±å“

æ­»é”ä¼šä¸¥é‡é€ æˆç³»ç»Ÿèµ„æºçš„æŸè€—ï¼š Aã€Bä¸¤ä¸ªçº¿ç¨‹å¤„äºé•¿æœŸç­‰å¾…çŠ¶æ€ï¼›resource-a\resource-bä¸¤ä¸ªèµ„æºè¢«æ­»é”çš„çº¿ç¨‹ é•¿æœŸé”ä½ï¼Œä½†åˆæ— æ³•å‘æŒ¥ä½œç”¨

### æ­»é”ç¤ºä¾‹

![1574308533812](å¤šçº¿ç¨‹.assets/1574308533812.png)

```java
//æœ¬é¢˜å‡ºç°æ­»é”çš„æƒ…å†µ æ˜¯ä¸€ç§å‡è®¾ï¼ˆçº¿ç¨‹æ˜¯æ¦‚ç‡é—®é¢˜ï¼‰ï¼šå¦‚æœç¬¦åˆé¢„æœŸï¼ˆAç»™aåŠ äº†é”ï¼Œåœ¨ç­‰å¾…b;Bç»™båŠ äº†é”ï¼Œåœ¨ç­‰å¾…aï¼‰ï¼Œåˆ™ä¼šå‡ºç°æ­»é”ï¼›å¦åˆ™ï¼Œä¸ä¼š
class AThread implements  Runnable{
    @Override
    public void run() {
        synchronized (DeadLock.resource_a) {
            System.out.println("Açº¿ç¨‹ï¼šå·²ç»ç»™resource-aåŠ äº†é”");
            try {
                Thread.sleep((long)(Math.random()*3000) );
            } catch (InterruptedException e) {
                e.printStackTrace();
            }
			//synchronizedæ˜¯å¯é‡å…¥ğŸ”’ï¼Œå³åœ¨ğŸ”’çš„é‡Œé¢å¯ä»¥å†å¥—ä¸€æŠŠğŸ”’
            synchronized (DeadLock.resource_b){//å°è¯•ç»™BåŠ é”
                System.out.println("Açº¿ç¨‹ï¼šç­‰å¾…ç»™resource-båŠ é”...");
            }
        }
    }
}
class BThread implements  Runnable{
    @Override
    public void run() {
        synchronized (DeadLock.resource_b) {
            System.out.println("Bçº¿ç¨‹ï¼šå·²ç»ç»™resource-båŠ äº†é”");
            try {
                Thread.sleep((long)(Math.random()*3000) );
            } catch (InterruptedException e) {
                e.printStackTrace();
            }
            synchronized (DeadLock.resource_a){
                System.out.println("Bçº¿ç¨‹ï¼šç­‰å¾…ç»™resource-aåŠ é”...");
            }
        }
    }
}

public class DeadLock {
    static String resource_a = "resource-a" ;
    static String resource_b = "resource-b" ;

    public static void main(String[] args) {
        Thread A = new Thread(new AThread());
        Thread B = new Thread(new BThread());

        A.start();
        B.start();
    }

}

```

### æ­»é”çš„è§£å†³

äº§ç”Ÿæ­»é”çš„æ ¹æœ¬åŸå› ï¼šï¼ˆæ“ä½œç³»ç»ŸçŸ¥è¯†ï¼‰

- ç³»ç»Ÿèµ„æºä¸è¶³
- å¤šçº¿ç¨‹çš„æ‰§è¡Œé¡ºåºä¸åˆç†ï¼šç®—æ³•é—®é¢˜ï¼Œè§£å†³æ­»é” å¯ä»¥é€šè¿‡ç®—æ³•è§£å†³ï¼š é“¶è¡Œå®¶ç®—æ³•ï¼› â€äº§ç”Ÿæ­»é”æœ‰å››ä¸ªå¿…è¦æ¡ä»¶â€œï¼Œé¿å…æ­»é” å°±å¯ä»¥æ‰“ç ´å››ç§å¿…è¦æ¡ä»¶

## çº¿ç¨‹å®‰å…¨å’Œä¸å®‰å…¨çš„åŒºåˆ«


|                              | æ˜¯å¦åŒæ­¥é” | æ•ˆç‡ | ä½¿ç”¨åœºæ™¯         |
| ---------------------------- | ---------- | ---- | ---------------- |
| çº¿ç¨‹å®‰å…¨ï¼ˆä¸ä¼šå‡ºç°å¹¶å‘é—®é¢˜ï¼‰ | æ˜¯         | ä½   | å¹¶å‘è®¿é—®å…±äº«èµ„æº |
| éçº¿ç¨‹å®‰å…¨ï¼ˆå‡ºç°å¹¶å‘é—®é¢˜ï¼‰   | å¦         | é«˜   | ååé‡ä¼˜å…ˆ       |

å“ªä¸ªå¥½ï¼Ÿæ²¡æœ‰æœ€å¥½ï¼Œåªèƒ½è¯´æ ¹æ®å½“å‰ä¸šåŠ¡ å“ªä¸ªæ›´åŠ åˆé€‚

## jdkä¸­çš„çº¿ç¨‹å®‰å…¨/éçº¿ç¨‹å®‰å…¨çš„æ”¯æŒ

Hashtableï¼šçº¿ç¨‹å®‰å…¨ï¼Œæ•ˆç‡ä½

HashMapï¼šéçº¿ç¨‹å®‰å…¨ï¼Œæ•ˆç‡é«˜



StringBuffer/StringBuilder

StringBufferï¼šçº¿ç¨‹å®‰å…¨

StringBuilder: éçº¿ç¨‹å®‰å…¨



ArrayListï¼š1.éçº¿ç¨‹å®‰å…¨ï¼Œå¯èƒ½ä¼šå‡ºç°ä¸€äº›æ•°æ®ä¸å®‰å…¨çš„é—®é¢˜ï¼Œç”šè‡³æŠ¥é”™

â€‹                    2.åœ¨è®¾è®¡ä¹‹åˆ æ²¡æœ‰è¿‡å¤šçš„è€ƒè™‘å¹¶å‘é—®é¢˜ï¼Œå› æ­¤æœ‰ä¸€äº›é—®é¢˜

æºç ï¼š

~~~java
    /**
     * Appends the specified element to the end of this list.
     *
     * @param e element to be appended to this list
     * @return <tt>true</tt> (as specified by {@link Collection#add})
     */
    public boolean add(E e) {
        //åˆ¤æ–­å½“å‰å¤§å°æ˜¯å¦å¤Ÿç”¨ï¼Œå¦‚æœaã€bä¸¤ä¸ªçº¿ç¨‹éƒ½æ¥äº†ï¼Œåœ¨è¿™é‡Œåˆ¤æ–­ä¸ºå¤Ÿç”¨ï¼Œéƒ½å¾€é‡Œæ”¾å°±ä¼šé€ æˆçº¿ç¨‹å®‰å…¨é—®é¢˜
        ensureCapacityInternal(size + 1);  // Increments modCount!!
        elementData[size++] = e;
        return true;
    }
~~~

ç¤ºä¾‹ï¼šArrayListåœ¨è®¾è®¡æ—¶ å­˜åœ¨çš„é—®é¢˜

```java
package juc;

import java.util.ArrayList;
import java.util.Iterator;
import java.util.List;

public class ArrayListDemo {
    public static void main(String[] args) {
        List<String> list = new ArrayList<>();
        list.add("aaa") ;
        list.add("bb") ;
        list.add("cc") ;
        Iterator<String> iter = list.iterator();
        while(iter.hasNext()){
            System.out.println(iter.next());

            list.add("xxx");
        }
    }
}

```

![1574313931924](å¤šçº¿ç¨‹.assets/1574313931924.png)

ä»¥ä¸Šä»£ç ï¼Œçš„iter.next()æ˜¯java.util.ArrayList.Iträ¸­çš„next()æ–¹æ³•ã€‚

```java
        final void checkForComodification() {
            if (modCount != expectedModCount)
                throw new ConcurrentModificationException();
        }
```

modCoutnæ˜¯è¿­ä»£å™¨å®é™…çš„æŒ‡å‘ä½ç½®ï¼›expectedModCountæ˜¯è¿­ä»£å™¨æœŸæœ›çš„æŒ‡å‘ä½ç½®ï¼›ä¸ºäº†é˜²æ­¢æ•°æ®è¢«ç¯¡æ”¹ï¼Œarraylistä¼šåˆ¤æ–­äºŒè€…æ˜¯å¦ç›¸ç­‰ã€‚

é€šè¿‡æºç å¯çŸ¥ï¼šArrayListçš„add()ä¼šå¢åŠ modCount ã€‚æ­£å¸¸æµç¨‹ï¼šå…ˆadd()ï¼Œå¹¶ä¸”åœ¨add()æ—¶ä¼š å¢åŠ modCountï¼Œç„¶åiter.next()æ¥æ£€æŸ¥modCount\expectedModCountæ˜¯å¦ç›¸ç­‰ï¼› 

æœ¬ç¨‹åºçš„é”™è¯¯æµç¨‹ï¼šå…ˆadd()ï¼Œå†iter.next() ã€åˆadd()ã€åˆiter.next() 

> ä»¥ä¸Šï¼šif(modCount != expectedModCount)éå¸¸ç±»ä¼¼ ç‰ˆæœ¬æ§åˆ¶æŠ€æœ¯ï¼Œä¸¥æ ¼æ¥è®² è¢«ç§°ä¸º  "fail-fastç­–ç•¥"

**è§£å†³ï¼šä½¿ç”¨jucä¸­ç›¸åº”å¯¹ArrayListçš„å¹¶å‘æ”¯æŒï¼šCopyOnWriteArrayList**

## JUC

java.util.concurrentï¼šåŒ…åï¼Œä»jdk.1.5ä¹‹åæä¾›ï¼ŒåŒ…å«äº†å¾ˆå¤š ç”¨äºå¹¶å‘ç¼–ç¨‹çš„å·¥å…·ç±»

> å¹¶å‘å®¹å™¨ï¼šCopyOnWriteArrayListï¼ŒCopyOnWrite*... ,ConcurrentHashMap,Concurrent* ,PriorityBlockingQueue

### CopyOnWriteArrayList

![1574316982736](å¤šçº¿ç¨‹.assets/1574316065595.png)

ä½¿ç”¨CopyOnWriteè§£å†³ArrayListå¹¶å‘é—®é¢˜

> æ€æƒ³ è¯»å†™åˆ†ç¦»

```java
package juc;

import java.util.ArrayList;
import java.util.Iterator;
import java.util.List;
import java.util.concurrent.CopyOnWriteArrayList;

public class ArrayListDemo {
    public static void main(String[] args) {
        CopyOnWriteArrayList<String> list = new CopyOnWriteArrayList<>();
        list.add("aaa") ;
        list.add("bb") ;
        list.add("cc") ;
        Iterator<String> iter = list.iterator();
        while(iter.hasNext()){
            System.out.println(iter.next());
            list.add("xxx");
        }
        System.out.println("---");

        Iterator<String> iter2 = list.iterator();
        while(iter2.hasNext()){
            System.out.println(iter2.next());
        }
    }
}
```

### ConcurrentHashMap

#### ä½œç”¨

æå‡HashMapçš„å¹¶å‘æ€§èƒ½

#### ä¸¤ä¸ªå¤§ç‰ˆæœ¬

##### JDK7

###### HashMapç»“æ„

ç»“æ„= æ•°ç»„+é“¾è¡¨

* æ•°ç»„å±‚é¢

HashMapçš„å…ƒç´ æ˜¯ä¸€ä¸ª ç”±key-valueç»„æˆçš„å…ƒç´ ï¼ˆentry)

å¦‚æœentryå­˜æ”¾åˆ°hashmapä¸­ï¼š

ä¼šå…ˆæ ¹æ®æ­¤entryçš„keyå€¼è®¡ç®—å‡ºä¸€ä¸ª hashcodeï¼Œç„¶åå†å°†è¿™ä¸ªhashcodeå’Œæ•°ç»„çš„é•¿åº¦æ±‚ä½™ï¼Œè®¡ç®—å‡ºæ¥çš„å€¼ å°±æ˜¯æ•°ç»„çš„ä¸‹æ ‡ã€‚ä¹‹åè¯¥entryå…ƒç´  å°±ä¼šå­˜å…¥åˆ°è¯¥ä¸‹æ ‡å¯¹åº”çš„ æ•°ç»„ä¸­å…ƒç´ ä¸­ã€‚ä¾‹å¦‚ï¼Œentry(key=s01,value=stu01)ï¼šå…ˆè®¡ç®—s01çš„hashcode(æ¯”å¦‚æ˜¯123)ï¼Œç„¶å 123%æ•°ç»„é•¿åº¦(æ¯”å¦‚é•¿åº¦æ˜¯10) ï¼Œç»“æœæ˜¯3ã€‚ç„¶åè¿™ä¸ªç»“æœ3å°±æ˜¯æ•°ç»„å…ƒç´ çš„ä¸‹æ ‡ï¼Œæœ€åå°† è¯¥entryå­˜æ”¾å¦‚ æ•°ç»„çš„ç¬¬3ä¸ªä½ç½®ä¸­ã€‚

* é“¾è¡¨å±‚é¢

å¦‚æœæœ‰å¤šä¸ªentryæœ€ç»ˆçš„è®¡ç®—ç»“æœç›¸åŒï¼ˆkey01=111,key02=221,åˆ™è¿™ä¸¤ä¸ªentryçš„è®¡ç®—ç»“æœéƒ½æ˜¯1ï¼‰ï¼Œåˆ™è¿™ä¹ˆå¤šç›¸åŒç»“æœçš„entryç”¨é“¾è¡¨é“¾æ¥èµ·æ¥ã€‚

![1575253270159](å¤šçº¿ç¨‹.assets/1575253270159.png)

> HashMapæ˜¯éçº¿ç¨‹å®‰å…¨ï¼Œå¯èƒ½å­˜åœ¨å¹¶å‘é—®é¢˜ã€‚å¦‚ä½•è§£å†³ï¼ŸConcurrentHashMapå¯ä»¥ç”¨äºè§£å†³å¹¶å‘é—®é¢˜

###### ConcurrentHashMapç»“æ„

![1575254038723](å¤šçº¿ç¨‹.assets/1575254038723.png)

> è§£å†³å¹¶å‘é—®é¢˜ï¼šç»™æ¯ä¸€ä¸ªsegmentåŠ ä¸€æŠŠé”ã€‚æ—¢å¯ä»¥ç”¨é”æ¥é¿å…å¹¶å‘è®¿é—®æ—¶çš„å†²çªï¼›åˆé¿å…â€œç»™æ•´ä¸ªå®¹å™¨æ·é”â€å¯¼è‡´æ€§èƒ½é™ä½çš„æƒ…å†µ

##### JDK8

HashMap/ConcurrentHashMapç»“æ„ç±»ä¼¼

![1575254386215](å¤šçº¿ç¨‹.assets/1575254386215.png)



#### HashMap/ConcurrentHashMapåŒºåˆ«

ConcurrentHashMapè§£å†³å¹¶å‘é—®é¢˜ï¼šå¤§é‡ä½¿ç”¨äº†volatileï¼ˆçº¿ç¨‹å¯è§æ€§ï¼‰ã€synchronizedï¼ˆé”ï¼‰ã€CASæ— é”ç®—æ³•å®ç°çš„

> HashMap/ConcurrentHashMapäºŒè€…éƒ½æ˜¯ä¸€ä¸ªAbstractMapçš„å­ç±»ï¼Œæ˜¯å¹³çº§çš„ï¼ŒäºŒè€…ä¹‹é—´æ²¡æœ‰ç»§æ‰¿å…³ç³»

![1575254798494](å¤šçº¿ç¨‹.assets/1575254798494.png)



ä½¿ç”¨å±‚é¢ï¼šä¸è€ƒè™‘å¹¶å‘ï¼Œä½¿ç”¨HashMapï¼›å¦‚æœåœ¨é«˜å¹¶å‘ç¯å¢ƒï¼ŒConcurrentHashMapã€‚

ä½¿ç”¨æ¡ˆä¾‹ï¼š

```java
package juc;

import java.util.concurrent.ConcurrentHashMap;

public class TestConcurrentHashMap {
    public static void main(String[] args) {
        ConcurrentHashMap<String,Object> chm =  new ConcurrentHashMap<>();
        chm.put("s01", new Object());
        chm.put("s02", new Object());
        chm.put("s03", new Object());
        chm.putIfAbsent("s03",new Object());//å¦‚æœkeyä¸å­˜åœ¨ï¼Œåˆ™å¢åŠ ï¼›å¦åˆ™ä¸å¢åŠ 

        System.out.println(chm);
    }
}

```

## è¯»å†™é”

![1574750106718](å¤šçº¿ç¨‹.assets/1574750106718.png)

åœ¨ä¸€èˆ¬çš„é¡¹ç›®ä¸­ï¼Œéƒ½æ˜¯è¯»å¤šå†™å°‘ï¼Œå¹¶ä¸”åªæœ‰â€œå†™â€å¯èƒ½å¼•èµ·å¹¶å‘å†²çªã€‚ å°±å¯ä»¥è®¾ç½®æˆ è¯»å†™åˆ†ç¦»ï¼šè¯»å†™é”

### jucä¸­çš„è¯»å†™é”

```java
public interface ReadWriteLock {
    /**
     * Returns the lock used for reading.
     *
     * @return the lock used for reading
     */
    Lock readLock();

    /**
     * Returns the lock used for writing.
     *
     * @return the lock used for writing
     */
    Lock writeLock();
}

```

- è¯»é”ï¼šreadLock()ã€‚åŠ äº†è¯»é”çš„èµ„æºï¼Œå¯ä»¥åœ¨æ²¡æœ‰å†™é”çš„æƒ…å†µä¸‹ è¢«å¤šä¸ªçº¿ç¨‹å…±äº«ã€‚å³ï¼šå¦‚æœt1çº¿ç¨‹å·²ç»åŠ äº†è¯»é”ï¼Œé‚£ä¹ˆæ­¤æ—¶ï¼š

  - å¦‚æœt2è¦ç”³è¯·å†™é”ï¼Œåˆ™t2ä¼šä¸€ç›´ç­‰å¾…t1è§£é”

  - å¦‚æœt2è¦ç”³è¯·è¯»é”ï¼Œåˆ™t2ä¼šç›´æ¥åŠ è¯»é”ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œt1å’Œt2å¯ä»¥å…±åŒåŠ è¯»é”ï¼ˆå¯é‡å…¥é”ï¼Œt1çº¿ç¨‹åŠ å®Œè¯»é”ä»¥åï¼Œt2çº¿ç¨‹ä¹Ÿå¯ä»¥å†åŠ ä¸€æŠŠè¯»é”ï¼‰

     > å°ç»“ï¼šå¦‚æœä¸€ä¸ªçº¿ç¨‹aåŠ äº†è¯»å†™ï¼Œå¦ä¸€äº›çº¿ç¨‹åªæœ‰åœ¨ ç”³è¯·åŠ å†™é”æ—¶ï¼Œæ‰éœ€è¦ç­‰å¾…çº¿ç¨‹aè§£é”

- å†™é”ï¼šwriteLock()ï¼Œç‹¬å é”ã€‚å¦‚æœä¸€ä¸ªçº¿ç¨‹aåŠ äº†å†™é”ï¼Œåˆ™å…¶ä»–çº¿ç¨‹å¿…é¡»ç­‰å¾…aè§£é”

ä¸€ä¸ªèµ„æºçº¿ç¨‹aåŠ äº†å†™é”ä»¥åï¼Œå…¶ä»–çº¿ç¨‹å¿…é¡»ç­‰å¾…çº¿ç¨‹aè§£é”ä»¥åï¼Œæ‰èƒ½è®¿é—®è¯¥èµ„æº

~~~java
package juc;

import java.util.concurrent.locks.ReadWriteLock;
import java.util.concurrent.locks.ReentrantReadWriteLock;

public class ReadWriteLockDemo {
    //å¯é‡å…¥çš„è¯»å†™é”
    ReentrantReadWriteLock rwl = new ReentrantReadWriteLock() ;
	
    public static void main(String[] args) {
        ReadWriteLockDemo demo = new  ReadWriteLockDemo();
            new Thread(  () ->{
                //è¯»
                demo.readMethod(Thread.currentThread());
                //å†™
                demo.writeMethod(Thread.currentThread());

            },"t1" ).start( );

            new Thread(   () ->{
                //è¯»
                demo.readMethod(Thread.currentThread());
                //å†™
                demo.writeMethod(Thread.currentThread());

            },"t2" ).start( );
    }

    //è¯»
    private void readMethod(Thread t ){
        //è¯»é”åŠ é”
        rwl.readLock().lock();
        try {
            for (int i = 0; i < 9999; i++) {
                System.out.println(t.getName() + "æ­£åœ¨æ‰§è¡Œè¯»æ“ä½œ...");
            }
            System.out.println(t.getName() + "è¯»æ“ä½œã€å®Œæ¯•ã€‘...");
        }finally {
            //è¯»é”è§£é”
            rwl.readLock().unlock();
        }
    }
    //å†™
    private void writeMethod(Thread t){
        //å†™é”åŠ é”
        rwl.writeLock().lock();
        try {
            for (int i = 0; i < 9999; i++) {
                System.out.println(t.getName() + "æ­£åœ¨æ‰§è¡Œå†™æ“ä½œ...");
            }
            System.out.println(t.getName() + "å†™æ“ä½œã€å®Œæ¯•ã€‘...");
        }finally {
            //å†™é”è§£é”
            rwl.writeLock().unlock();
        }
    }
}
~~~

## çº¿ç¨‹é€šä¿¡

### ç›®çš„

å¤šä¸ªçº¿ç¨‹åœ¨äº‰å¤ºåŒä¸€ä¸ªèµ„æºæ—¶ï¼Œä¸ºäº†ä¿è¯ååŒå·¥ä½œï¼Œå¯ä»¥è¿›è¡Œçº¿ç¨‹é€šä¿¡

> açº¿ç¨‹æ“ä½œå®Œèµ„æºä»¥åï¼Œå¯ä»¥é€šçŸ¥bçº¿ç¨‹æ¥æ“ä½œèµ„æº

### é€šä¿¡ä¸»è¦ä¾èµ–äº3ä¸ªæ–¹æ³•

- waitï¼ˆï¼‰ã€è‡ªå·±ä½¿è‡ªå·±ã€‘ï¼šä½¿å½“å‰çº¿ç¨‹å¤„ç†ç­‰å¾…çŠ¶æ€ï¼ˆé˜»å¡ï¼‰ï¼Œä¸€ç›´åˆ°å…¶ä»–çº¿ç¨‹è°ƒç”¨æ­¤çº¿ç¨‹çš„notify()æˆ–notifyAll()æ–¹æ³•
- notify()ã€åˆ«äººè°ƒè‡ªå·±ã€‘ï¼šå”¤é†’ä¸€ä¸ªæ­£åœ¨ç­‰å¾…çº¿ç¨‹ï¼›å¦‚æœæœ‰å¤šä¸ªçº¿ç¨‹æ­£åœ¨ç­‰å¾…ï¼Œåˆ™éšæœºå”¤é†’ä¸€ä¸ªã€‚
- notifyAll()ã€åˆ«äººè°ƒè‡ªå·±ã€‘ï¼šå”¤é†’å…¨éƒ¨æ­£åœ¨ç­‰å¾…çš„çº¿ç¨‹

### æ³¨æ„äº‹é¡¹

#### ç­‰å¾…çš„çº¿ç¨‹ç”±è°å”¤é†’ï¼Ÿ

çº¿ç¨‹åœ¨ç­‰å¾…æ—¶ï¼Œä¼šè¢«ä¸€ä¸ªç›‘å¬å™¨æ‰€ç›‘å¬ï¼Œå› æ­¤ï¼Œå½“å…¶ä»–çº¿ç¨‹è°ƒç”¨notify()ã€notifyAll()æ—¶ï¼Œå®é™…æ˜¯é€šè¿‡ç›‘å¬å™¨æ¥å”¤é†’çº¿ç¨‹

![1575339511878](å¤šçº¿ç¨‹.assets/1575339511878.png)

#### ä¸‰ä¸ªçº¿ç¨‹é€šä¿¡çš„æ–¹æ³•ç”±è°å®šä¹‰ï¼Ÿ

æ˜¯Objectå®šä¹‰nativeæ–¹æ³•ã€‚å› ä¸ºé”æ˜¯ å¯¹è±¡çº§ï¼Œä¸æ˜¯çº¿ç¨‹çº§çš„ã€‚

```java
synchronized{
    ...
}

```

å› ä¸ºä»»ä½•å¯¹è±¡éƒ½å¯ä»¥ä½¿ç”¨synchronizedåŠ é”ï¼Œè€Œçº¿ç¨‹é€šä¿¡åˆä¾èµ–äºåŠ é”ï¼Œå› æ­¤çº¿ç¨‹é€šä¿¡å±äºâ€œä»»ä½•å¯¹è±¡â€çš„ä½¿ç”¨èŒƒå›´ï¼Œå³å¯¹è±¡çº§ï¼Œæ‰€ä»¥æ˜¯åœ¨Objectä¸­å®šä¹‰çš„ã€‚

#### æ–¹æ³•å®šä¹‰çš„ä½ç½®

è¿™ä¸‰ä¸ªæ–¹æ³•ï¼Œå¿…é¡»å®šä¹‰åœ¨synchronizedä¸­å®šä¹‰ï¼Œå¦åˆ™æŠ¥å¼‚å¸¸

> å¿…é¡»åŠ é”æ‰èƒ½é€šä¿¡

#### å»ºè®®

jdkå»ºè®®ï¼šä¸ºäº†é¿å…ä¸€äº›å¹¶å‘é—®é¢˜ï¼Œå»ºè®®å°†wait()æ–¹æ³•å†™åœ¨å¾ªç¯ä¸­ï¼Œå¦‚ä¸‹ï¼š

```java
     * As in the one argument version, interrupts and spurious wakeups are
     * possible, and this method should always be used in a loop:
     * <pre>
     *     synchronized (obj) {
     *         while (&lt;condition does not hold&gt;)
     *             obj.wait();
     *         ... // Perform action appropriate to condition
     *     }
     * </pre>
```

### ä¿¡å·é‡Semaphor

* Semaphorç¼–ç¨‹
  * é»˜è®¤æ‰€æœ‰çš„çº¿ç¨‹éƒ½æ˜¯é˜»å¡
  * æœ‰ä¸ªä¸€è®¸å¯acquire()ï¼Œåªæœ‰è·å–äº†è®¸å¯çš„çº¿ç¨‹ ï¼Œæ‰èƒ½è¿è¡Œ
  * è®¸å¯çš„æ•°é‡ï¼Œå¯ä»¥é€šè¿‡persmitså±æ€§è®¾ç½®
  * release()é‡Šæ”¾è®¸å¯

ä»¥ä¸‹ç¤ºä¾‹ï¼šæœ‰10ä¸ªçº¿ç¨‹å°è¯•æ‰§è¡Œï¼Œä½†åªæœ‰3ä¸ªè®¸å¯è¯

```java
package juc;

import java.util.concurrent.ExecutorService;
import java.util.concurrent.Executors;
import java.util.concurrent.Semaphore;

public class SemaphoreDemo {
    public static void main(String[] args) {

        ExecutorService executor = Executors.newCachedThreadPool();
        //åŒä¸€æ—¶é—´ æœ€å¤šæœ‰3ä¸ªçº¿ç¨‹å¯ä»¥å¹¶å‘è¿è¡Œ
        Semaphore sem = new Semaphore(3) ;
        //å‡è®¾æœ‰10ä¸ªçº¿ç¨‹
        for( int i=0;i<10;i++){
            final int tId = i ;
            executor.execute(
                         () ->{
                             try{
                                 //è·å–è®¸å¯ï¼ˆåŒä¸€æ—¶é—´ åªæœ‰3ä¸ªè®¸å¯ï¼‰
                                 sem.acquire();
                                 System.out.println("çº¿ç¨‹" + tId +"è·å–åˆ°äº†è®¸å¯ï¼Œæ­£åœ¨æ‰§è¡Œ");
                                Thread.sleep((long)(5000*Math.random()));
                                sem.release();//é‡Šæ”¾è®¸å¯
                             }catch (InterruptedException e){

                             }catch(Exception e){
                                 e.printStackTrace();
                             }
                         }
            );//ç»™çº¿ç¨‹ä¸­ åŠ å…¥ä¸€ä¸ªæ–°çº¿ç¨‹
        }
//            executor.shutdown();
    }
}
```

## ç”Ÿäº§è€…æ¶ˆè´¹è€…æ¡ˆä¾‹ï¼ˆçº¿ç¨‹é€šä¿¡ï¼‰

![1575341703565](å¤šçº¿ç¨‹.assets/1575341703565.png)

### åº“å­˜

```java
package Thread.scxfmodel;

/**
 * @program: fileTest
 * @description: åº“å­˜
 * @author: dzp
 * @create: 2021-04-25 16:08
 **/
public class GoodsStock {

    int goodNum;

    public synchronized void produce() {
        try {
            if (goodNum < 100) {
                goodNum++;
                //å”¤é†’æ¶ˆè´¹è€…
                notifyAll();
                //éšæœºç¡ä¸€ç§’ä»¥å†…
                Thread.sleep((int) (Math.random() * 10));
                System.out.println("ç”Ÿäº§å•†å“ï¼Œæ•°é‡æ˜¯ï¼š" + goodNum);
            } else {
                //ä½¿è‡ªå·±é˜»å¡
                wait();
            }
        } catch (InterruptedException e) {
            e.printStackTrace();
        }

    }

    public synchronized void consume() {
        try {
            if (goodNum > 0) {
                goodNum--;
                //å”¤é†’ç”Ÿäº§è€…
                notifyAll();
                //éšæœºç¡ä¸€ç§’ä»¥å†…
                Thread.sleep((int) (Math.random() * 10));
                System.out.println("æ¶ˆè´¹å•†å“ï¼Œæ•°é‡æ˜¯ï¼š" + goodNum);
            } else {
                //ä½¿è‡ªå·±é˜»å¡
                wait();
            }
        } catch (InterruptedException e) {
            e.printStackTrace();
        }
    }
}
```

### ç”Ÿäº§è€…

```java
package Thread.scxfmodel;

/**
 * @program: fileTest
 * @description: ç”Ÿäº§è€…
 * @author: dzp
 * @create: 2021-04-25 16:09
 **/
public class GoodsProducer implements Runnable {

    GoodsStock goodsStock = new GoodsStock();

    GoodsProducer() {
    }

    GoodsProducer(GoodsStock goodsStock) {
        this.goodsStock = goodsStock;
    }

    @Override
    public void run() {
        while (true) {
            goodsStock.produce();
        }
    }
}
```

### æ¶ˆè´¹è€…

```java
package Thread.scxfmodel;

/**
 * @program: fileTest
 * @description: æ¶ˆè´¹è€…
 * @author: dzp
 * @create: 2021-04-25 16:10
 **/
public class GoodsConsumer implements Runnable {

    GoodsStock goodsStock = new GoodsStock();

    GoodsConsumer() {
    }

    GoodsConsumer(GoodsStock goodsStock) {
        this.goodsStock = goodsStock;
    }

    @Override
    public void run() {
        while (true) {
            goodsStock.consume();
        }
    }
}
```

æµ‹è¯•

```java
package Thread.scxfmodel;

/**
 * @program: fileTest
 * @description: ceshi
 * @author: dzp
 * @create: 2021-04-25 16:35
 **/
public class Test {
    public static void main(String[] args) {
        //åº“å­˜
        GoodsStock goodsStock = new GoodsStock();
        //ç”Ÿäº§è€…ï¼ˆå¤šä¸ªç”Ÿäº§è€…äº«å—ä¸€ä¸ªåº“å­˜ï¼‰
        GoodsProducer goodsProducer = new GoodsProducer(goodsStock);
        //æ¶ˆè´¹è€…
        GoodsConsumer goodsConsumer = new GoodsConsumer(goodsStock);

        Thread gp1 = new Thread(goodsProducer, "gp1");
        Thread gp2 = new Thread(goodsProducer, "gp2");

        Thread gc1 = new Thread(goodsConsumer, "gc1");
        Thread gc2 = new Thread(goodsConsumer, "gc2");

        gp1.start();
        gp2.start();

//        gc1.start();
        gc2.start();

    }
}
```

è¿è¡Œç»“æœ

![1575341679342](å¤šçº¿ç¨‹.assets/1575341679342.png)



## æ”¹é€ ç”Ÿäº§è€…æ¶ˆè´¹è€…ï¼ˆçº¿ç¨‹é€šä¿¡ï¼‰

![1575425882245](å¤šçº¿ç¨‹.assets/1575425882245.png)

### é˜Ÿåˆ—ã€çº¿ç¨‹æ± 

å•†å“

```java
package producerandconsumer2;
//å•†å“
public class Goods {
    private int id ;
    private String name ;

    public Goods() {
    }
    public Goods(int id, String name) {
        this.id = id;
        this.name = name;
    }

    public int getId() {
        return id;
    }

    public void setId(int id) {
        this.id = id;
    }

    public String getName() {
        return name;
    }

    public void setName(String name) {
        this.name = name;
    }
}

```

å¸¦é˜Ÿåˆ—çš„åº“å­˜ï¼š

```java
package producerandconsumer2;

import sun.security.provider.NativePRNG;

import java.util.concurrent.BlockingQueue;
import java.util.concurrent.TimeUnit;

//åº“å­˜
public class GoodsStock {
    //é˜Ÿåˆ—ï¼šç”Ÿäº§è€…å’Œæ¶ˆè´¹è€… å…±äº«çš„é˜Ÿåˆ—
    private BlockingQueue<Goods> queue ;
    //è®°å½•ä¸€å…±ç”Ÿäº§äº†å¤šå°‘å•†å“
    private static int count ;

    public GoodsStock(BlockingQueue<Goods> queue) {
        this.queue = queue;
    }

    public GoodsStock() {
    }
    
    //æ–°å¢
    public synchronized void produceGoods(){
        try {
            Goods goods = new Goods();
            //3ç§’ä¹‹å†…æ”¾æˆåŠŸï¼Œå°±ç®—æˆåŠŸ
            boolean flag = queue.offer(goods, 3, TimeUnit.SECONDS);
            if(flag){
                count++ ;
                goods.setId(count);
                goods.setName("goods"+count);
                System.out.println("ç”Ÿäº§æˆåŠŸï¼šå•†å“ç¼–å·ï¼š"+goods.getId()+",åå­—ï¼š"+goods.getName()  );
                Thread.sleep((long)(Math.random()*10));
				
                //æœ‰æ–°å•†å“äº†ï¼Œé€šçŸ¥æ¶ˆè´¹è€…æ¶ˆè´¹...
                notifyAll();
            }else{
                System.out.println("ç”Ÿäº§å•†å“å¤±è´¥...");
            }

            if(queue.size() >= 100){
                System.out.println("åº“å­˜å·²æ»¡ï¼Œç­‰å¾…æ¶ˆè´¹ã€‚ã€‚ã€‚");
                wait();
            }


        }catch(Exception e){
            e.printStackTrace();
        }

    }

    //å‡å°‘
    public synchronized void consumeGoods(){
        try {
            Goods goods = queue.poll(3, TimeUnit.SECONDS);
            if(goods != null){
                System.out.println("æ¶ˆè´¹goodsï¼Œç¼–å·ï¼š"+goods.getId()+ ",åç§°ï¼š"+goods.getName());
                Thread.sleep( (long)(Math.random()*10) );
                //æ¶ˆè´¹æˆåŠŸï¼Œé€šçŸ¥ç”Ÿäº§è€…ç”Ÿäº§
                notifyAll();
            }else{
                System.out.println("æ¶ˆè´¹å¤±è´¥ã€‚ã€‚ã€‚");
            }
            if(queue.size()>0){

            }else{
                System.out.println("åº“å­˜ä¸ºç©ºï¼Œç­‰å¾…ç”Ÿäº§ã€‚ã€‚ã€‚");
                wait();
            }
        }catch (Exception e){
            e.printStackTrace();
        }

    }
}

```

ç”Ÿäº§è€…

```java
package producerandconsumer2;

public class GoodsProducer implements Runnable {

    GoodsStock stock ;

    public GoodsProducer(){

    }

    public GoodsProducer(GoodsStock stock){
        this.stock = stock ;
    }

    @Override
    public void run() {
        //ç”Ÿäº§å•†å“
        while(true){
            stock.produceGoods();//ç”Ÿäº§
        }
    }
}

```

æ¶ˆè´¹è€…

```java
package producerandconsumer2;

public class GoodsConsumer implements Runnable {
    
    GoodsStock goodsStock ;

    public GoodsConsumer(){
    }
   
    public GoodsConsumer(GoodsStock goodsStock){
        this.goodsStock = goodsStock ;
    }

    @Override
    public void run() {
        while(true){
            goodsStock.consumeGoods();
        }
    }
}

```

æµ‹è¯•

```java
package producerandconsumer2;

import java.util.concurrent.BlockingQueue;
import java.util.concurrent.ExecutorService;
import java.util.concurrent.Executors;
import java.util.concurrent.LinkedBlockingQueue;

public class Test {
    public static void main(String[] args) throws InterruptedException {
        BlockingQueue<Goods> queue = new LinkedBlockingQueue<>(100);
		//å•†å“åº“å­˜
        GoodsStock goodsStock = new GoodsStock(queue) ;

        GoodsProducer produce1 = new GoodsProducer(goodsStock) ;
        GoodsProducer produce2 = new GoodsProducer(goodsStock) ;

        GoodsConsumer consumer1 = new GoodsConsumer(goodsStock) ;
        GoodsConsumer consumer2 = new GoodsConsumer(goodsStock) ;

        //å°†ç”Ÿäº§è€…å’Œæ¶ˆè´¹è€…åŠ å…¥çº¿ç¨‹æ± 
        ExecutorService executorService = Executors.newCachedThreadPool();
        //ä»çº¿ç¨‹æ± ä¸­å–çº¿ç¨‹æ‰§è¡Œç”Ÿäº§è€…å’Œæ¶ˆè´¹è€…
        executorService.execute(produce1);
        executorService.execute(produce2);
        executorService.execute(consumer1);
        executorService.execute(consumer2);
        Thread.sleep(20000);
        executorService.shutdown();
    }
}
```

## Lockï¼ˆçº¿ç¨‹é€šä¿¡ï¼‰

* ç¬¬ä¸€ç§æ–¹å¼ï¼š

```
synchronized + wait()/notify()/notifyAll()
```

* å¦ä¸€ç§å½¢å¼ï¼ˆæ›´åŠ å¼ºå¤§ï¼‰ï¼š

synchronized {}  åŠ é”/è§£é”   â€”â€”    Lock( lock(), unlock() )  åŠ é”/è§£é”

wait()                â€”â€”    Conditionä¸­çš„await()æ–¹æ³•

notify()/notifyAll() â€”â€”Conditionä¸­çš„signal()/signalAll()æ–¹æ³•

* ä¿®æ”¹åLockæ–¹å¼ä¿®æ”¹ä»¥ä¸Šä»£ç 

```java
package producerandconsumer3;

import java.util.concurrent.BlockingQueue;
import java.util.concurrent.TimeUnit;
import java.util.concurrent.locks.Condition;
import java.util.concurrent.locks.Lock;
import java.util.concurrent.locks.ReentrantLock;

//åº“å­˜
public class GoodsStock {
    //é˜Ÿåˆ—ï¼šç”Ÿäº§è€…å’Œæ¶ˆè´¹è€… å…±äº«çš„é˜Ÿåˆ—
    private BlockingQueue<Goods> queue ;
    private static int count ;//è®°å½•ä¸€å…±ç”Ÿäº§äº†å¤šå°‘é‡å•†å“
	//ä½¿ç”¨å¯é‡å…¥é” açº¿ç¨‹åŠ å®Œ bçº¿ç¨‹å¯ä»¥å†åŠ 
    private Lock lock = new ReentrantLock() ;
    private Condition condition =  lock.newCondition();

    public GoodsStock(BlockingQueue<Goods> queue) {
        this.queue = queue;
    }

    public GoodsStock() {
    }
    //æ–°å¢
    public  void produceGoods(){
        //åŠ é”
        lock.lock();
        try {
            Goods goods = new Goods();
            boolean flag = queue.offer(goods, 3, TimeUnit.SECONDS);
            if(flag){
                count++ ;
                goods.setId(count);
                goods.setName("goods"+count);
                System.out.println("ç”Ÿäº§æˆåŠŸï¼šå•†å“ç¼–å·ï¼š"+goods.getId()+",åå­—ï¼š"+goods.getName() +",åº“å­˜ï¼š"+ queue.size() );
                Thread.sleep((long)(Math.random()*10));
				//æœ‰æ–°å•†å“äº†ï¼Œé€šçŸ¥æ¶ˆè´¹è€…æ¶ˆè´¹...
                //notifyAll();
                condition.signalAll();
            }else{
                System.out.println("ç”Ÿäº§å•†å“å¤±è´¥...");
            }

            if(queue.size() >= 100){
                System.out.println("åº“å­˜å·²æ»¡ï¼Œç­‰å¾…æ¶ˆè´¹ã€‚ã€‚ã€‚");
				// wait();
                condition.await();
            }
        }catch(Exception e){
            e.printStackTrace();
        }finally {
            //è§£é”
            lock.unlock();
        }

    }

    //å‡å°‘
    public  void consumeGoods(){
        lock.lock();
        try {
            Goods goods = queue.poll(3, TimeUnit.SECONDS);
            if(goods != null){
                System.out.println("æ¶ˆè´¹goodsï¼Œç¼–å·ï¼š"+goods.getId()+ ",åç§°ï¼š"+goods.getName() +",åº“å­˜ï¼š"+ queue.size());
                Thread.sleep( (long)(Math.random()*10) );
//                notifyAll();
                condition.signalAll();
            }else{
                System.out.println("æ¶ˆè´¹å¤±è´¥ã€‚ã€‚ã€‚");
            }
            if(queue.size()>0){

            }else{
                System.out.println("åº“å­˜ä¸ºç©ºï¼Œç­‰å¾…ç”Ÿäº§ã€‚ã€‚ã€‚");
//                wait();
                condition.await();
            }


        }catch (Exception e){
            e.printStackTrace();
        }finally {
            lock.unlock();
        }

    }
}

```

## Synchronizedä¸Lockçš„åŒºåˆ«

|      | synchronized                  | Lock                               |
| ---- | ----------------------------- | ---------------------------------- |
| å½¢å¼ | å…³é”®å­—                        | æ¥å£                               |
| åŠ é” | {                             | lock()ï¼Œå°è¯•åŠ é”ï¼ˆå°è¯•ä¸€æ®µæ—¶é—´ç­‰ï¼‰ |
| è§£é” | }ï¼Œæ–¹æ³•æ­£å¸¸ç»“æŸæˆ–ç¨‹åºå‡ºç°å¼‚å¸¸ | unlock()                           |
| çŠ¶æ€ | æ— æ³•åˆ¤æ–­                      | å¯ä»¥åˆ¤æ–­                           |
| ä¸­æ–­ | ä¸æ”¯æŒ                        | æ”¯æŒ                               |

> synchronizedåŠ é”æ–¹å¼ä¸ºç›´æ¥åŠ é”ï¼ŒæˆåŠŸå³æˆåŠŸï¼Œå¤±è´¥å³å¤±è´¥ï¼Œä½†æ˜¯lock()å¦‚æœåŠ é”å¤±è´¥ï¼Œå¯ä»¥åœ¨ä¸€æ®µæ—¶é—´å†…å°è¯•å†æ¬¡åŠ é”ï¼ˆå¦‚3ç§’ï¼Œ3ç§’å†…åŠ é”å¤±è´¥å¯ä»¥å°è¯•å†æ¬¡åŠ é”ï¼‰

**å»ºè®®ï¼šå»ºè®®ä½¿ç”¨Lockï¼Œæ›´åŠ å¼ºå¤§**

å°è¯•åŠ é”çš„ä»£ç 

```java
package juc;

import java.util.concurrent.TimeUnit;
import java.util.concurrent.locks.Lock;
import java.util.concurrent.locks.ReentrantLock;

public class TryLockDemo extends Thread {
    //è®¾ä¸ºé™æ€ï¼Œä¸¤ä¸ªçº¿ç¨‹å…±ç”¨ä¸€æŠŠé”
  	private static Lock lock =   new ReentrantLock();
    @Override
    public void run() {
        String threadName = Thread.currentThread().getName();
        boolean flag = false ;
        try {
            //å°è¯•åŠ é” 5 æ¯«ç§’
           	flag = lock.tryLock(5, TimeUnit.MICROSECONDS);
            System.out.println("å°è¯•åŠ é”ç»“æœï¼š"+flag);
            if(flag){
                System.out.println(threadName+"åŠ é”æˆåŠŸ...");
                //åŠ é”æˆåŠŸä»¥åï¼Œå ç”¨èµ„æº0.02ç§’
                Thread.sleep(20);
            }else{
                System.out.println(threadName+"åŠ é”å¤±è´¥ã€‚ã€‚ã€‚");
            }
        }catch (Exception e){
            e.printStackTrace();
        }finally {
            //å¦‚æœæ˜¯åŠ é”ï¼Œå†æ¥è§£é”
            if(flag) {
                System.out.println(threadName + "è§£é”...");
                lock.unlock();
            }
        }
    }

    public static void main(String[] args) {
        TryLockDemo t1 = new TryLockDemo();
        TryLockDemo t2 = new TryLockDemo();
        t1.setName("t1");
        t2.setName("t2");
        t1.start();
        t2.start();

    }
}
```

## ä¸­æ–­ç­‰å¾…

åœºæ™¯ï¼šå¦‚æœçº¿ç¨‹tè¦è®¿é—®æŸä¸ªä¸€èµ„æºï¼Œä½†æ­¤èµ„æºå·²ç»è¢«å…¶ä»–çº¿ç¨‹é•¿æœŸåŠ äº†é”ï¼Œåˆ™çº¿ç¨‹tå¯ä»¥è¢«å…¶ä»–çº¿ç¨‹ç»“æŸç­‰å¾…çŠ¶æ€ï¼ˆå°†è¯¥ç­‰å¾…çº¿ç¨‹ä¸­æ–­ï¼‰

* Apiä½¿ç”¨

```
lock.lockInterruptibly();//åŠ äº†ä¸€æŠŠå¯è¢«ä¸­æ–­çš„é”

å¦‚ä½•ä¸­æ–­ï¼Ÿ è°ƒç”¨ä¸€ä¸ªinterrupt();

å¦‚æœçº¿ç¨‹è¢«ä¸­æ–­ ä¼šæŠ›å‡ºä¸€ä¸ªå¼‚å¸¸InterruptedException
```

* ä»£ç é€»è¾‘

åœ¨mainä¸­æœ‰ä¸‰ä¸ªçº¿ç¨‹t1ã€t2ã€mainï¼Œmainä¼‘çœ ä¸€ç§’ï¼Œt1å’Œt2ä¼‘çœ ä¸‰ç§’ï¼Œmainé†’äº†ä»¥åï¼Œä¸­æ–­çº¿ç¨‹t2

```java
package juc;

import java.util.concurrent.locks.Lock;
import java.util.concurrent.locks.ReentrantLock;

class MyThread extends  Thread{
    WaitInterrupt waitInterrupt ;
    public MyThread(WaitInterrupt waitInterrupt){
        this.waitInterrupt = waitInterrupt ;
    }


    @Override
    public void run() {
        try {
            waitInterrupt.myLock(Thread.currentThread());//å½“å‰çº¿ç¨‹ä¼‘çœ 3ç§’
        }catch (Exception e){
            System.out.println(Thread.currentThread().getName()+"è¢«ä¸­æ–­");
        }
    }
}

public class WaitInterrupt {
    private Lock lock = new ReentrantLock() ;

    public static void main(String[] args) throws  Exception {

        WaitInterrupt inter = new WaitInterrupt();
        MyThread t1 = new MyThread(inter);
        t1.setName("t1");
        MyThread t2 = new MyThread(inter);
        t2.setName("t2");

        t1.start();//ä¼‘çœ 3ç§’
        t2.start();//ä¼‘çœ 3ç§’

        Thread.sleep(1000);//mainçº¿ç¨‹ä¼‘çœ 1ç§’
        t2.interrupt();//ä¸­æ–­t2
    }


    public void myLock(Thread thread   )throws InterruptedException {
        try {

            lock.lockInterruptibly();//åŠ äº†ä¸€æŠŠå¯è¢«ä¸­æ–­çš„é”

            System.out.println( thread.getName() + "åŠ é”");
            Thread.sleep(3000);
        }
        finally
        {
            lock.unlock();
            System.out.println( thread.getName() + "è§£é”");
        }
    }

}

```

![1575430758651](å¤šçº¿ç¨‹.assets/1575430758651.png)



## æ— é”ç®—æ³•CAS

ä¸ºäº†ä¿è¯å¹¶å‘ç¯å¢ƒä¸‹çš„æ•°æ®å®‰å…¨ï¼Œå¯ä»¥ä½¿ç”¨é”ï¼Œä¹Ÿå¯ä»¥ä½¿ç”¨ä¸€ç§æ— é”ç®—æ³•â€”â€”CASç®—æ³•

### åŠ é”ç¼ºç‚¹

æ¶ˆè€—ç³»ç»Ÿèµ„æºæ¯”è¾ƒå¤§ï¼ˆåˆ‡æ¢ä¸Šä¸‹æ–‡å¯¹è±¡ã€æœ¬æ¥cpuç»™äº†çº¿ç¨‹t1ï¼Œç°åœ¨ç»™çº¿ç¨‹t2ã€‘ï¼Œé€ æˆCPUè°ƒåº¦å¾ˆé¢‘ç¹ï¼‰ã€‚å¦‚å›¾ï¼Œå°†cpuä»t1åˆ‡æ¢åˆ°t2æ˜¯ä¸€ç§æ¯”è¾ƒæ¶ˆè€—CPUèµ„æºçš„æ“ä½œ

![1575511425462](å¤šçº¿ç¨‹.assets/1575511425462.png)



### åŠ é”ä¸CASå¯¹æ¯”ï¼ˆæ‚²è§‚é”å’Œä¹è§‚é”ï¼‰

åŠ é”ï¼šæ˜¯ä¸€ç§æ‚²è§‚ç­–ç•¥ï¼Œçº¿ç¨‹åœ¨è®¿é—®èµ„æºæ—¶  æ€»è®¤ä¸ºä¼šå’Œå…¶ä»–èµ„æºé€ æˆå†²çªï¼Œå› æ­¤éœ€è¦åŠ é”ã€‚

CASï¼šæ˜¯ä¸€ç§ä¹è§‚ç­–ç•¥ï¼Œçº¿ç¨‹åœ¨è®¿é—®èµ„æºæ—¶  æ€»è®¤ä¸ºä¸ä¼šå’Œå…¶ä»–èµ„æºé€ æˆå†²çªï¼Œå› æ­¤æœ‰ä¸¤ç§å¯èƒ½ï¼š

- å‡è®¾æˆåŠŸï¼ˆçš„ç¡®æ²¡æœ‰å’Œå…¶ä»–çº¿ç¨‹äº§ç”Ÿå†²çªï¼‰

  OK

- å‡è®¾å¤±è´¥ï¼ˆå®é™…å’Œå…¶ä»–çº¿ç¨‹äº§ç”Ÿäº†å†²çªï¼‰

  é‡æ–°è·å–æœ€æ–°çš„èµ„æºï¼Œç„¶åå†æ¬¡è®¿é—®ï¼ˆå¦‚æœå‘ç°è¦è®¿é—®çš„èµ„æºä¸æ˜¯æœ€æ–°çš„ï¼Œåˆ™ä¸€ç›´å°è¯•ï¼›ç›´åˆ°æ‹¿åˆ°æœ€æ–°æ•°æ®ä¸ºæ­¢ï¼‰

![1575511868575](å¤šçº¿ç¨‹.assets/1575511868575.png)

## å¤šçº¿ç¨‹æ‰“å°ï¼ˆä¹ é¢˜ï¼‰

* ä½¿ç”¨synchronizedå®ç°

~~~java
package Thread;

/**
 * @program: fileTest
 * @description: å¾ªç¯æ‰“å°
 * å¤šçº¿ç¨‹äº¤æ›¿æ‰“å°123123123...ï¼ˆä¸¤ç§ä»¥ä¸Šæ–¹æ³•å®ç°ï¼‰
 * ä¸€ã€
 * num:æ‰“å°çš„æ•°å­—1ã€2ã€3
 * çº¿ç¨‹1ï¼šåˆ¤æ–­æ•°å­—æ˜¯å¦ä¸º1ï¼Œå¦‚æœæ˜¯åˆ™æ‰“å°ï¼Œå¦‚æœä¸æ˜¯åˆ™ç­‰å¾…ï¼Œæ‰“å°å®Œä»¥åé€šçŸ¥çº¿ç¨‹2
 * çº¿ç¨‹2ï¼šåˆ¤æ–­æ•°å­—æ˜¯å¦ä¸º2ï¼Œå¦‚æœæ˜¯åˆ™æ‰“å°ï¼Œå¦‚æœä¸æ˜¯åˆ™ç­‰å¾…ï¼Œæ‰“å°å®Œä»¥åé€šçŸ¥çº¿ç¨‹3
 * çº¿ç¨‹3ï¼šåˆ¤æ–­æ•°å­—æ˜¯å¦ä¸º3ï¼Œå¦‚æœæ˜¯åˆ™æ‰“å°ï¼Œå¦‚æœä¸æ˜¯åˆ™ç­‰å¾…ï¼Œæ‰“å°å®Œä»¥åé€šçŸ¥çº¿ç¨‹1
 * @author: dzp
 * @create: 2021-04-26 15:43
 **/

/**
 * æ‰“å°
 */
public class LoopPrint {

    int num = 1;

    public void print1() throws InterruptedException {
        synchronized (this) {
            if (num == 1) {
                System.out.print(num);
                Thread.sleep(1000);
                num = 2;
                notifyAll();
            } else {
                wait();
            }
        }
    }

    public void print2() throws InterruptedException {
        synchronized (this) {
            if (num == 2) {
                System.out.print(num);
                Thread.sleep(1000);
                num = 3;
                notifyAll();
            } else {
                wait();
            }
        }
    }

    public void print3() throws InterruptedException {
        synchronized (this) {
            if (num == 3) {
                System.out.print(num);
                Thread.sleep(1000);
                num = 1;
                notifyAll();
            } else {
                wait();
            }
        }
    }

    public static void main(String[] args) {
        LoopPrint loopPrint = new LoopPrint();

        new Thread(() -> {
            while (true) {
                try {
                    loopPrint.print1();
                } catch (InterruptedException e) {
                    e.printStackTrace();
                }
            }
        }).start();

        new Thread(() -> {
            while (true) {
                try {
                    loopPrint.print2();
                } catch (InterruptedException e) {
                    e.printStackTrace();
                }
            }
        }).start();

        new Thread(() -> {
            while (true) {
                try {
                    loopPrint.print3();
                } catch (InterruptedException e) {
                    e.printStackTrace();
                }
            }
        }).start();
    }
}
~~~

* ä½¿ç”¨Lockæ¥å£å®ç°

~~~java
package Thread;

import java.util.concurrent.locks.Condition;
import java.util.concurrent.locks.Lock;
import java.util.concurrent.locks.ReentrantLock;

/**
 * @program: fileTest
 * @description: æ‰“å°çº¿ç¨‹02
 * @author: dzp
 * @create: 2021-04-26 16:22
 **/
public class LoopPrintByLock {
    /**
     * ä¸€ä¸ªå˜é‡
     */
    private int num = 1;

    /**
     * åªæœ‰ä¸€ä¸ªå˜é‡ï¼Œå› æ­¤åªéœ€è¦ä¸€æŠŠé”ã€‚ä½†éœ€è¦é€šçŸ¥ä¸‰ä¸ªçº¿ç¨‹ï¼Œå› æ­¤éœ€è¦ä¸‰ä¸ªâ€œæ¡ä»¶é€šçŸ¥â€
     */
    Lock lock = new ReentrantLock();

    /**
     * ä¸‰ä¸ªé€šçŸ¥
     */
    Condition condition1 = lock.newCondition();
    Condition condition2 = lock.newCondition();
    Condition condition3 = lock.newCondition();

    public void print1() {
        //åŠ é”
        lock.lock();
        try {
            //çº¿ç¨‹1ï¼š åˆ¤æ–­numæ˜¯å¦ä¸º1ï¼Œå¦‚æœä¸æ˜¯ï¼Œåˆ™ç­‰å¾…ï¼›å¦‚æœæ˜¯ï¼Œåˆ™æ‰“å°ï¼Œæ‰“å°å®Œå [é€šçŸ¥]çº¿ç¨‹2
            if (num != 1) {
                condition1.await();
            }
            System.out.print(num);
            Thread.sleep(3000);
            num = 2;
            condition2.signal();
        } catch (Exception e) {
            System.out.println(e);
        } finally {
            //è§£é”
            lock.unlock();
        }
    }

    public void print2() {
        //åŠ é”
        lock.lock();
        try {
            //çº¿ç¨‹2ï¼š åˆ¤æ–­numæ˜¯å¦ä¸º2ï¼Œå¦‚æœä¸æ˜¯ï¼Œåˆ™ç­‰å¾…ï¼›å¦‚æœæ˜¯ï¼Œåˆ™æ‰“å°ï¼Œæ‰“å°å®Œå [é€šçŸ¥]çº¿ç¨‹3
            if (num != 2) {
                condition2.await();
            }
            System.out.print(num);
            Thread.sleep(3000);
            num = 3;
            condition3.signal();
        } catch (Exception e) {
            System.out.println(e);
        } finally {
            //è§£é”
            lock.unlock();
        }
    }

    public void print3() {
        //åŠ é”
        lock.lock();
        try {
            //çº¿ç¨‹3ï¼š åˆ¤æ–­numæ˜¯å¦ä¸º3ï¼Œå¦‚æœä¸æ˜¯ï¼Œåˆ™ç­‰å¾…ï¼›å¦‚æœæ˜¯ï¼Œåˆ™æ‰“å°ï¼Œæ‰“å°å®Œå [é€šçŸ¥]çº¿ç¨‹1
            if (num != 3) {
                condition3.await();
            }
            System.out.print(num);
            Thread.sleep(3000);
            num = 1;
            condition1.signal();
        } catch (Exception e) {
            System.out.println(e);
        } finally {
            //è§£é”
            lock.unlock();
        }
    }

    public static void main(String[] args) {
        LoopPrintByLock loopPrintByLock = new LoopPrintByLock();
        new Thread(() -> {
            while (true) {
                loopPrintByLock.print1();
            }
        }).start();

        new Thread(() -> {
            while (true) {
                loopPrintByLock.print2();
            }
        }).start();

        new Thread(() -> {
            while (true) {
                loopPrintByLock.print3();
            }
        }).start();
    }
}
~~~

* ä½¿ç”¨Semaphoreä¿¡å·é‡å®ç°

~~~java
package Thread;

import java.util.concurrent.Semaphore;

/**
 * @program: fileTest
 * @description: é€šè¿‡ä¿¡å·é‡å®ç°æ‰“å°
 * @author: dzp
 * @create: 2021-04-28 18:13
 **/
public class LoopPrintBySemaphore {

    /**
     * è¦æ‰“å°1 2 3 éœ€è¦3ä¸ªä¿¡å·é‡ åªæœ‰ä¸€ä¸ªé€šä¿¡è¯
     * 1 æ‹¿åˆ°æ‰“å°1
     * 2 æ‹¿åˆ°æ‰“å°2
     * 3 æ‹¿åˆ°æ‰“å°3
     */
    Semaphore sem1 = new Semaphore(1);
    Semaphore sem2 = new Semaphore(0);
    Semaphore sem3 = new Semaphore(0);

    /**
     * @param value   å½“å‰å€¼ 1 2 3
     * @param current å½“å‰è°ç”¨è®¸å¯è¯
     * @param next    ä¸‹ä¸€ä¸ªè°æ‹¿è®¸å¯è¯
     */
    private void print(int value, Semaphore current, Semaphore next) {
        while (true) {
            try {
                //å½“å‰ä¿¡å·é‡ è·å–è®¸å¯è¯
                current.acquire();
                System.out.print(value);
                Thread.sleep(1000);
                //å°†è®¸å¯è¯ä¼ é€’ç»™ä¸‹ä¸€ä¸ª
                next.release();
            } catch (InterruptedException e) {
                e.printStackTrace();
            }
        }
    }

    private void print1() {
        print(1, sem1, sem2);
    }

    private void print2() {
        print(2, sem2, sem3);
    }

    private void print3() {
        print(3, sem3, sem1);
    }

    public static void main(String[] args) {
        LoopPrintBySemaphore loopPrintBySemaphore = new LoopPrintBySemaphore();
        new Thread(() -> {
            loopPrintBySemaphore.print1();
        }).start();

        new Thread(() -> {
            loopPrintBySemaphore.print2();
        }).start();

        new Thread(() -> {
            loopPrintBySemaphore.print3();
        }).start();
    }
}
~~~










































